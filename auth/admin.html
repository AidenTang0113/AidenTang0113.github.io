<!DOCTYPE html>
<html>
<head>
    <title>Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/milligram/1.4.1/milligram.min.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="column">
                <h1>User Management</h1>
                <div id="usersList"></div>
                <a href="/auth/dashboard.html" class="button">Back to Dashboard</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { getAllUsers, updateUserAdminStatus, deleteUser } from '../script/admin.js'
        import { getCurrentUser } from '../script/auth.js'
        
        try {
            const { profile } = await getCurrentUser()
            if (!profile.is_admin) {
                window.location.href = '/auth/dashboard.html'
            }
            
            async function renderUsers() {
                try {
                    const users = await getAllUsers()
                    
                    document.getElementById('usersList').innerHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Admin</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${user.username}</td>
                                        <td>${user.email}</td>
                                        <td>
                                            <input type="checkbox" 
                                                ${user.is_admin ? 'checked' : ''}
                                                onchange="handleAdminChange('${user.id}', this.checked)"
                                                ${user.id === profile.id ? 'disabled' : ''}>
                                        </td>
                                        <td>
                                            <button class="button button-clear" 
                                                onclick="handleDelete('${user.id}')"
                                                ${user.id === profile.id ? 'disabled' : ''}>
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `
                } catch (error) {
                    alert(`Failed to load users: ${error.message}`)
                }
            }
            
            window.handleAdminChange = async (userId, isAdmin) => {
                try {
                    await updateUserAdminStatus(userId, isAdmin)
                    alert('User updated successfully')
                } catch (error) {
                    alert(`Update failed: ${error.message}`)
                    renderUsers() // Refresh to reset checkbox
                }
            }
            
            window.handleDelete = async (userId) => {
                if (confirm('Are you sure you want to delete this user?')) {
                    try {
                        await deleteUser(userId)
                        renderUsers()
                    } catch (error) {
                        alert(`Delete failed: ${error.message}`)
                    }
                }
            }
            
            renderUsers()
        } catch (error) {
            console.error('Admin error:', error)
            window.location.href = '/auth/login.html'
        }
    </script>
</body>
</html>